@model SistemaLavanderia.Core.Entities.Pedido
@using System.Security.Claims

@{
    ViewData["Title"] = $"Pedido #{Model.Id}";
    var perfil = User.FindFirst("Perfil")?.Value ?? "Cliente";
    
    // Mapa de serviços por ID
    var mapaServicos = new Dictionary<int, string>
    {
        { 1, "Lavagem Simples" },
        { 2, "Lavagem a Seco" },
        { 3, "Passadoria" },
        { 4, "Lavagem por Quilo" },
        { 5, "Tinturaria" }
    };
    
    // MAPA DE PREÇOS SIMPLIFICADO - Apenas os 3 valores que você usa
    var mapaPrecos = new Dictionary<decimal, string>
    {
        { 40.00m, "Calça" },
        { 60.00m, "Vestido" },
        { 70.00m, "Jaqueta" }
    };
}

<div class="container mt-4">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-file-invoice"></i> Pedido #@Model.Id</h1>
        <span class="badge @(Model.Status switch {
            "Aguardando" => "bg-warning",
            "Lavando" => "bg-info",
            "Pronto" => "bg-success",
            "Entregue" => "bg-secondary",
            "Cancelado" => "bg-danger",
            _ => "bg-primary"
        }) fs-5 p-3">@Model.Status</span>
    </div>

    <div class="row">
        <!-- Coluna da esquerda - Informações do Cliente -->
        <div class="col-md-6">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-user"></i> Informações do Cliente</h5>
                </div>
                <div class="card-body">
                    @if (Model.Cliente != null)
                    {
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%"><i class="fas fa-user"></i> Nome:</th>
                                <td><strong>@Model.Cliente.Nome</strong></td>
                            </tr>
                            <tr>
                                <th><i class="fas fa-phone"></i> Telefone:</th>
                                <td>@(Model.Cliente.Telefone ?? "Não informado")</td>
                            </tr>
                            <tr>
                                <th><i class="fas fa-envelope"></i> Email:</th>
                                <td>@(Model.Cliente.Email ?? "Não informado")</td>
                            </tr>
                            <tr>
                                <th><i class="fas fa-map-marker-alt"></i> Endereço:</th>
                                <td>@(Model.Cliente.Endereco ?? "Não informado")</td>
                            </tr>
                        </table>
                    }
                    else
                    {
                        <p class="text-muted">Cliente ID: @Model.ClienteId</p>
                    }
                </div>
            </div>
        </div>

        <!-- Coluna da direita - Informações do Pedido -->
        <div class="col-md-6">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-clock"></i> Informações do Pedido</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th width="40%"><i class="fas fa-calendar-alt"></i> Data do Pedido:</th>
                            <td><strong>@Model.DataPedido.ToString("dd/MM/yyyy HH:mm")</strong></td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-calendar-check"></i> Data Prevista:</th>
                            <td>
                                @if (Model.DataPrevistaEntrega.HasValue)
                                {
                                    <strong>@Model.DataPrevistaEntrega.Value.ToString("dd/MM/yyyy")</strong>
                                }
                                else
                                {
                                    <span class="text-muted">Não definida</span>
                                }
                            </td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-tag"></i> Status:</th>
                            <td>
                                <span class="badge @(Model.Status switch {
                                    "Aguardando" => "bg-warning",
                                    "Lavando" => "bg-info",
                                    "Pronto" => "bg-success",
                                    "Entregue" => "bg-secondary",
                                    "Cancelado" => "bg-danger",
                                    _ => "bg-primary"
                                })">@Model.Status</span>
                            </td>
                        </tr>
                        <tr>
                            <th><i class="fas fa-dollar-sign"></i> Valor Total:</th>
                            <td><h4 class="text-success">@Model.ValorTotal.ToString("C")</h4></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Observações do Pedido -->
    @if (!string.IsNullOrEmpty(Model.Observacoes))
    {
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="fas fa-comment"></i> Observações do Cliente</h5>
            </div>
            <div class="card-body">
                <p class="mb-0">@Model.Observacoes</p>
            </div>
        </div>
    }

    <!-- Itens do Pedido -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="fas fa-tshirt"></i> Itens do Pedido</h5>
        </div>
        <div class="card-body">
            @if (Model.ItensPedido != null && Model.ItensPedido.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>#</th>
                                <th>Tipo de Roupa</th>
                                <th>Serviço</th>
                                <th>Quantidade</th>
                                <th>Preço Unit.</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int itemIndex = 1;
                                decimal totalItens = 0;
                            }
                            @foreach (var item in Model.ItensPedido)
                            {
                                totalItens += item.Subtotal;
                                
                                // Determinar o tipo de roupa baseado no preço
                                string tipoRoupa = mapaPrecos.ContainsKey(item.PrecoUnitario) 
                                    ? mapaPrecos[item.PrecoUnitario] 
                                    : "Não especificado";
                                
                                // Determinar o nome do serviço
                                string nomeServico = item.Servico != null 
                                    ? item.Servico.Nome 
                                    : (mapaServicos.ContainsKey(item.ServicoId) 
                                        ? mapaServicos[item.ServicoId] 
                                        : $"Serviço #{item.ServicoId}");
                                
                                string descricaoServico = item.Servico?.Descricao ?? "-";
                                
                                <tr>
                                    <td><strong>@itemIndex</strong></td>
                                    <td>
                                        <span class="fw-bold text-primary">@tipoRoupa</span>
                                        <br />
                                        <small class="text-muted">(R$ @item.PrecoUnitario.ToString("F2")/un)</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">@nomeServico</span>
                                        @if (!string.IsNullOrEmpty(descricaoServico) && descricaoServico != "-")
                                        {
                                            <br />
                                            <small class="text-muted">@descricaoServico</small>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary fs-6">@item.Quantidade</span>
                                    </td>
                                    <td class="text-end">@item.PrecoUnitario.ToString("C")</td>
                                    <td class="text-end">
                                        <strong class="text-success">@item.Subtotal.ToString("C")</strong>
                                    </td>
                                </tr>
                                itemIndex++;
                            }
                        </tbody>
                        <tfoot class="table-dark">
                            <tr>
                                <td colspan="5" class="text-end"><strong>TOTAL:</strong></td>
                                <td class="text-end"><h5 class="mb-0 text-white">@totalItens.ToString("C")</h5></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
            else
            {
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> Este pedido não possui itens.
                </div>
            }
        </div>
    </div>

    <!-- Botões de ação -->
    <div class="d-flex justify-content-between mt-4">
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Voltar para Lista
        </a>
        
        @if (perfil == "Cliente" && Model.Status == "Aguardando")
        {
            <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger">
                <i class="fas fa-trash"></i> Cancelar Pedido
            </a>
        }
        
        @if (perfil == "Admin")
        {
            <div class="btn-group">
                <button type="button" class="btn btn-warning dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-sync-alt"></i> Alterar Status
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <form asp-action="UpdateStatus" method="post" style="display: inline;">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" name="status" value="Aguardando" class="dropdown-item">
                                <i class="fas fa-clock text-warning"></i> Aguardando
                            </button>
                        </form>
                    </li>
                    <li>
                        <form asp-action="UpdateStatus" method="post" style="display: inline;">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" name="status" value="Lavando" class="dropdown-item">
                                <i class="fas fa-water text-info"></i> Lavando
                            </button>
                        </form>
                    </li>
                    <li>
                        <form asp-action="UpdateStatus" method="post" style="display: inline;">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" name="status" value="Pronto" class="dropdown-item">
                                <i class="fas fa-check-circle text-success"></i> Pronto
                            </button>
                        </form>
                    </li>
                    <li>
                        <form asp-action="UpdateStatus" method="post" style="display: inline;">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" name="status" value="Entregue" class="dropdown-item">
                                <i class="fas fa-truck text-secondary"></i> Entregue
                            </button>
                        </form>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form asp-action="UpdateStatus" method="post" style="display: inline;">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" name="status" value="Cancelado" class="dropdown-item text-danger">
                                <i class="fas fa-ban"></i> Cancelado
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        }
    </div>
</div>

<style>
    .card {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .card-header {
        font-weight: bold;
    }
    .table-borderless th {
        font-weight: 600;
        color: #555;
    }
    .badge {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }
    .table td {
        vertical-align: middle;
    }
    .text-primary {
        color: #0d6efd !important;
    }
    .text-success {
        color: #198754 !important;
    }
    .bg-secondary {
        background-color: #6c757d !important;
    }
    .bg-info {
        background-color: #0dcaf0 !important;
    }
    .bg-warning {
        background-color: #ffc107 !important;
    }
    .bg-danger {
        background-color: #dc3545 !important;
    }
    .btn-group .btn {
        margin-left: 5px;
    }
</style>